import { type BaseChatModel } from "@langchain/core/language_models/chat_models";
import { type BaseMessage } from "@langchain/core/messages";
import { type Logger } from "winston";

import { type AnalysisTask, type DiagnosticTask } from "../taskProviders";
import { type EvaluationTools } from "./tools";
import { type TaskManager } from "../taskManager";
import { type KaiRunnerConfig } from "../types";

/**
 * Represents application metadata and coordinates
 */
export interface TestApplication {
  readonly path: string; // path to app.yaml
  readonly name: string;
  readonly sourceCode:
    | {
        type: "git";
        url: string;
        branch: string;
        path?: string;
      }
    | {
        type: "local";
        path: string;
      };
  readonly programmingLanguage: string;
  readonly architecture: string;
  readonly sources?: string[];
  readonly targets?: string[];
}

/**
 * Represents test case metadata and coordinates
 */
export interface TestCase {
  readonly path: string; // path to tc.yaml
  readonly name: string;
  readonly description: string;
  readonly rules: {
    readonly ruleset: string;
    readonly rule: string;
  }[];
  readonly migrationHint: string;
  readonly testSelectors?: string[];
  readonly timeoutMs: number;
  readonly application: TestApplication;
  readonly notes: string;
}

/*
 * Returns the results for a test case from multple experiment runs
 * Each experiment runs the test case under unique parameters e.g. agent enabled/disabled.
 */
export interface TestCaseResults {
  readonly testCase: TestCase;
  errors: Error[];
  results: ExperimentResults[];
}

export interface TestCaseVariant {
  readonly name: string;
  readonly agentMode: boolean;
  readonly solutionServerUrl?: string;
}

/*
 * Results for a single experiment run of a test case
 * name is unique identifier for the experiment run.
 */
export interface ExperimentResults {
  readonly name: string; // identifies a variant
  readonly model: string;
  readonly completeness: Metric;
  readonly functionalParity: Metric;
  readonly residualEffort: Metric;
  readonly diff: string; // diff generated by the model is included in the results
  readonly error?: string; // error message if the experiment failed
}

export interface Metric {
  readonly reasoning: string;
  readonly score: number;
}

export interface BeforeAfter<T> {
  readonly before: T;
  readonly after: T;
}

/**
 * We build tools dynamically for a given test case.
 * The tools operate on frozen results we inited with.
 */
export interface EvaluationToolOptions {
  readonly analysisIssues: BeforeAfter<AnalysisTask[]>;
  readonly diagnosticsIssues: BeforeAfter<DiagnosticTask[]>;
  readonly fileList: BeforeAfter<string[]>;
  readonly changedFiles: Map<string, string>;
  readonly appArchitecture: string;
  readonly originalRules: {
    readonly ruleset: string;
    readonly rule: string;
  }[];
}

export interface EvaluationRunOptions {
  readonly variants?: TestCaseVariant[];
}

export interface EvaluationRunner {
  run: (
    testCases: TestCase[],
    opts: EvaluationRunOptions,
  ) => Promise<TestCaseResults[]>;
}

export interface AgentInput {
  testCase: TestCase;
  evaluationTools: EvaluationTools;
  issues: string; // Pre-formatted issues string
  model: BaseChatModel;
  logger: Logger;
}

export interface AgentResult {
  metric: Metric;
  responses: BaseMessage[];
  error?: string;
}

export type GetTaskManagerFunction = (
  logger: Logger,
  config: KaiRunnerConfig,
) => Promise<{
  taskManager: TaskManager;
  shutdownFunc: () => Promise<void>;
}>;

export type KaiRunnerFunction = (
  logger: Logger,
  tc: TestCase,
  application: TestApplication,
  variant: TestCaseVariant,
  config: KaiRunnerConfig,
) => Promise<void>;
